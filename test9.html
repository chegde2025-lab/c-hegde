<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CompanionClaimSet Documentation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            background-color: #f4f6f9;
            line-height: 1.6;
        }
        h1, h2, h3 {
            color: #1f4e79;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0px 4px 15px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 30px;
        }
        .highlight {
            background-color: #eef5ff;
            padding: 12px;
            border-left: 5px solid #1f4e79;
        }
        pre {
            background-color: #272822;
            color: #f8f8f2;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        table, th, td {
            border: 1px solid #ccc;
        }
        th {
            background-color: #1f4e79;
            color: white;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
        ul {
            margin-top: 10px;
        }
    </style>
</head>
<body>

<div class="container">

<h1>CompanionClaimSet – Enterprise Documentation</h1>

<div class="section">
<h2>1. Overview</h2>
<div class="highlight">
CompanionClaimSet is a structured grouping of multiple related claims 
originating from the same loss event. It enables aggregated financial tracking, 
shared policy limit validation, deductible allocation, catastrophe tracking, 
and consolidated reporting.
</div>
</div>

<div class="section">
<h2>2. Business Use Cases</h2>
<ul>
    <li>Multi-party accidents</li>
    <li>Catastrophe events (Flood, Earthquake, Storm)</li>
    <li>Shared policy limits</li>
    <li>Subrogation & recovery tracking</li>
    <li>Reinsurance aggregation</li>
    <li>Fraud investigation</li>
</ul>
</div>

<div class="section">
<h2>3. Core Tables</h2>

<h3>Companion Claim Set (Header)</h3>
<pre>
CREATE TABLE companion_claim_set (
    companion_set_id     NUMBER PRIMARY KEY,
    loss_event_id        NUMBER,
    policy_id            NUMBER,
    master_claim_id      NUMBER,
    catastrophe_code     VARCHAR2(50),
    shared_limit_flag    CHAR(1),
    status               VARCHAR2(20),
    version_number       NUMBER,
    created_date         DATE DEFAULT SYSDATE
);
</pre>

<h3>Companion Claim Link</h3>
<pre>
CREATE TABLE companion_claim_link (
    companion_set_id     NUMBER,
    claim_id             NUMBER,
    lead_claim_flag      CHAR(1),
    PRIMARY KEY (companion_set_id, claim_id)
);
</pre>

</div>

<div class="section">
<h2>4. Financial Calculations</h2>

<h3>Total Companion Reserve</h3>
<pre>
SELECT SUM(r.amount)
FROM reserve r
JOIN companion_claim_link l
  ON r.claim_id = l.claim_id
WHERE l.companion_set_id = :setId
AND r.status = 'OPEN';
</pre>

Formula:
<pre>
Total Reserve = Sum(Open Reserves of All Companion Claims)
</pre>

<h3>Total Companion Paid</h3>
<pre>
SELECT SUM(p.amount)
FROM payment p
JOIN companion_claim_link l
  ON p.claim_id = l.claim_id
WHERE l.companion_set_id = :setId
AND p.status = 'ISSUED';
</pre>

Formula:
<pre>
Total Paid = Sum(All Issued Payments)
</pre>

<h3>Outstanding Amount</h3>
<pre>
Outstanding = Total Reserve - Total Paid
</pre>

<h3>Net Incurred</h3>
<pre>
Net Incurred = Total Paid + Outstanding
</pre>

</div>

<div class="section">
<h2>5. Shared Policy Limit Validation</h2>

Formula:
<pre>
Total Paid (All Companion Claims) ≤ Policy Limit
</pre>

SQL Example:
<pre>
SELECT p.policy_limit,
       SUM(pay.amount) total_paid
FROM policy p
JOIN claim c ON p.policy_id = c.policy_id
JOIN payment pay ON c.claim_id = pay.claim_id
JOIN companion_claim_link l
  ON c.claim_id = l.claim_id
WHERE l.companion_set_id = :setId
GROUP BY p.policy_limit;
</pre>

</div>

<div class="section">
<h2>6. Shared Deductible Allocation</h2>

Formula:
<pre>
Claim Share % = Claim Reserve / Total Companion Reserve
Claim Deductible = Total Deductible × Share %
</pre>

Example:
<pre>
Total Reserve = 100,000
Claim1 Reserve = 50,000
Deductible = 10,000
Claim1 Deductible = 5,000
</pre>

</div>

<div class="section">
<h2>7. Recovery Distribution</h2>

Formula:
<pre>
Recovery Share = Claim Paid / Total Paid × Recovery Amount
</pre>

</div>

<div class="section">
<h2>8. Catastrophe-Level Reporting</h2>

Metrics:
<ul>
    <li>Total Claims Count</li>
    <li>Total Reserve</li>
    <li>Total Paid</li>
    <li>Net Incurred</li>
    <li>Loss Ratio</li>
</ul>

Loss Ratio Formula:
<pre>
Loss Ratio = Net Incurred / Premium
</pre>

</div>

<div class="section">
<h2>9. Automatic Companion Set Creation Logic</h2>

<pre>
1. New claim created
2. Check existing companion set by:
   - policy_id
   - loss_event_id
3. If exists → link claim
4. Else → create new companion_claim_set
5. Update financial aggregates
</pre>

</div>

<div class="section">
<h2>10. End-to-End Process Flow</h2>

<pre>
Loss Event Occurs
        ↓
Multiple Claims Created
        ↓
Create CompanionClaimSet
        ↓
Link Claims
        ↓
Aggregate Financials
        ↓
Validate Shared Limits
        ↓
Allocate Deductible
        ↓
Monitor Net Incurred
        ↓
Generate Reporting
</pre>

</div>

<div class="section">
<h2>11. Enterprise Controls</h2>
<ul>
    <li>Lead Claim Flag</li>
    <li>Version Tracking</li>
    <li>Shared Limit Enforcement</li>
    <li>Catastrophe Code Tracking</li>
    <li>Fraud Detection Monitoring</li>
    <li>Reinsurance Layer Support</li>
</ul>
</div>

<div class="section">
<h2>12. Final Definition</h2>
<div class="highlight">
CompanionClaimSet is a structured enterprise grouping of related claims 
that enables aggregated financial calculations, shared policy validations, 
deductible allocation, recovery distribution, and catastrophe-level reporting.
</div>
</div>

</div>

</body>
</html>
